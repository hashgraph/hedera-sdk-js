version: "3"

tasks:
    check-node:
        desc: "Check if Node.js is installed and meets the version requirement"
        silent: true
        cmds:
            - echo "Checking Node.js version..."
            - |
                if ! command -v node &> /dev/null || [ "$(node -v | cut -d'.' -f1)" -lt "v20" ]; then
                  echo "Node.js v20 or higher is required. Please install it."
                  exit 1
                fi

    check-npm:
        desc: "Check if npm is installed and meets the version requirement"
        silent: true
        cmds:
            - echo "Checking npm version..."
            - |
                if ! command -v npm &> /dev/null || [ "$(npm -v | cut -d'.' -f1)" -lt "10" ]; then
                  echo "NPM v10 or higher is required. Please install it."
                  exit 1
                fi

    install-hedera-local:
        desc: "Install Hedera Local Node CLI tool if not installed"
        silent: true
        cmds:
            - echo "Checking for Hedera Local Node CLI..."
            - |
                if ! command -v hedera &> /dev/null; then
                  echo "Hedera Local Node CLI not found, installing..."
                  npm install @hashgraph/hedera-local -g
                else
                  echo "Hedera Local Node CLI is already installed."
                fi

    start-local-node:
        desc: "Start the local Hedera network"
        silent: true
        deps: [check-node, check-npm, install-hedera-local]
        cmds:
            - echo "Starting local Hedera network..."
            - hedera start

    build-tck-js-server:
        desc: "Build the Docker image for tck-js-server"
        silent: true
        cmds:
            - echo "Building Docker image for tck-js-server..."
            - docker build -t tck-js-server .

    start-all-tests:
        desc: "Start Docker Compose services"
        silent: true
        deps: [start-local-node, build-tck-js-server]
        cmds:
            - echo "Starting Docker Compose services..."
            - docker compose up

    default:
        desc: "Start local node and Docker Compose"
        silent: true
        deps: [start-all-tests]
